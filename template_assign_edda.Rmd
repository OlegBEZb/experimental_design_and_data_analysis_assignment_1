---
title: "Assignment template"
author: "James Bond, group 007"
date: "1 February 2033"
output:
  pdf_document: default
  html_document:
    df_print: paged
highlight: tango
fontsize: 11pt
editor_options: 
  chunk_output_type: inline
  markdown: 
    wrap: 72
---

## Short introduction to R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax
for authoring HTML, PDF, and MS Word documents. R Markdown files permit
you to interweave R code with ordinary text to produce well-formatted
data analysis reports that are easy to modify. The R Markdown file
itself shows the readers exactly how you got the results in your report.
For more details on using R Markdown see
[\color{blue}{\underline{http://rmarkdown.rstudio.com}}](http://rmarkdown.rstudio.com).

When you click the **Knit** button, a document will be generated that
includes both content as well as the output of any embedded R code
chunks within the document. For inline R code, surround code with back
ticks and r. R replaces inline code with its results. For example, two
plus one is `r 2+1`; for the build-in R dataset `cars`, there were
`r nrow(cars)` cars studied. You can embed an R code chunk like this:

```{r}
summary(cars)
```

### Figures

You can also embed plots, for example:

```{r,echo=FALSE,fig.height=3.5}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to
prevent printing of the R code that generated the plot. Use knitr
options to style the output of a chunk. Place options in brackets above
the chunk. Other options with the defaults are: the `eval=FALSE` option
just displays the R code (and does not run it); `warning=TRUE` whether
to display warnings; `tidy=TRUE` wraps long code so it does not run off
the page.

You can control the size and placement of figures. For example, you can
put two figures (or more) next to each other. Use `par(mfrow=c(n,m))` to
create `n` by `m` plots in one picture in R. You can adjust the
proportions of figures by using the `fig.width` and `fig.height` chunk
options. These are specified in inches, and will be automatically scaled
down to fit within the handout margin. Chunk option `fig.align` takes
values `left`, `right`, or `center` (to align figures in the output
document).

```{r,fig.margin = TRUE,fig.width=6,fig.height=3,fig.align="center"}
par(mfrow=c(1,2)); x1=rnorm(50); hist(x1); qqnorm(x1)
```

You can arrange for figures to span across the entire page by using the
`fig.fullwidth` chunk option.

```{r,fig.fullwidth=TRUE,fig.height=3}
plot(iris$Sepal.Length,iris$Petal.Length,xlab="Sepal.Length",ylab="Petal.Length")
```

More about chunk options can be found at
[\color{blue}{\underline{https://yihui.name/knitr/options/}}](https://yihui.name/knitr/options/).

### Equations

To produce mathematical symbols, you can also include
\LaTeX expessions/equations in your report: inline
$\frac{d}{dx}\left(\int_{0}^{x} f(u)\,du\right)=f(x)$ and in the display
mode: <!-- \[ -->
<!-- \frac{d}{dx}\left( \int_{0}^{x} f(u)\,du\right)=f(x). -->
<!-- \] --> To be able to use this functionality, \LaTeX has to be
installed.

### Footnotes

Here is the use of a footnote[^1].

[^1]:
    ## Exercise 1. Waiting time

    A researcher measured (in minutes) how long patients have to wait in
    the waiting room of a doctor's office: 15.4, 17.9, 19.0, 0.5, 15.9,
    2.7, 6.2, 2.5, 4.7, 6.9, 10.8, 24.3, 5.6, 23.0, 10.7. Denote the
    mean waiting time by /mu.

### Images

Want an image? This will do it. To depict an image (say, `my_image.jpg`
which should be in your current working directory), use this command

<!-- ![caption for my image](my_image.jpg) -->

### Tables

Want a table? This will create one (note that the separators *do not*
have to be aligned).

| Table Header | Second Header |
|--------------|---------------|
| Table Cell   | Cell 2        |
| Cell 3       | Cell 4        |

You can also make table by using knit's `kable` function:

```{r echo=FALSE, results='asis'}
library(knitr)
kable(mtcars[1:5,],caption="A knit kable.")
```

### Block quote

> This will create a block quote, if you want one.

### Verbatim

    This text is displayed verbatim/preformatted.

### Links

Links: <http://example.com>, [in-text link to
Google](http://google.com).

This is a \hyperlink{target1}{{\color{blue}{\underline{hyperlink}}}}.

\hypertarget{target1}{{\color{blue}{\underline{This}}}}

is where the hyperlink jumps to.

### Itimization, italicized and embolded text

-   Single asterisks italicize text *like this*.
-   Double asterisks embolden text **like this**.

One more way to italicize and embold: *italic* and **bold**.

## Exercise 1

Below is a template for reporting the exercises from the assignments.

**a)** Here are some consequitive R-commands.

```{r}
x=rep(c("A","B"),each=5); x
sample(x)
x=rnorm(100)
```

Now the same code chunk but with all the output collapsed into signle
block.

```{r, collapse=TRUE}
x=rep(c("A","B"),each=5); x
sample(x)
x=rnorm(100)
```

**b)** Below we perform a one sample t-test for the artificial data
(that we generate ourselves).

```{r}
mu=0.2
x=rnorm(100,mu,1) # creating artificial data
t.test(x,mean=0)   # t.test(x,alternative=c("two.sided"),conf.level=0.95,mu=10)
```

**c)** We often do not need to report the whole output of R-commands,
only certain values of the output. For example, below we perform a
two-sample t-test and report only the (appropriately rounded) values of
t-statistics and the p-pavue.

```{r}
mu=0;nu=0.5
x=rnorm(50,mu,1); y=rnorm(50,nu,1) # creating artificial data
ttest=t.test(x,y) 
```

The value of t-statistics in the above evaluation is
`r round(ttest[[1]],2)` and the p-value is `r round(ttest[[3]],4)`.

## Exercite 1. Waiting time.

A researcher measured (in minutes) how long patients have to wait in the
waiting room of a doctor's office: 15.4, 17.9, 19.0, 0.5, 15.9, 2.7,
6.2, 2.5, 4.7, 6.9, 10.8, 24.3, 5.6, 23.0, 10.7. Denote the mean waiting
time by $\mu$.

```{r}
x <- as.numeric(list(15.4, 17.9, 19.0, 0.5, 15.9, 2.7, 6.2, 2.5, 4.7, 6.9, 10.8, 24.3, 5.6, 23.0, 10.7))
```

**a)** Check normality of the data. Assuming normality (irrespective of
your conclusion about normality of the data), construct a 97%-CI for
$\mu$. Evaluate the sample size needed to provide that the length of the
97%-CI is at most 2. Compute a bootstrap 97%-CI for $\mu$ and compare it
to the above CI.

Let's check the normality using Shapiro-Wilk test. $H_0$ is that sample
$x$ came from normally distributed population.

```{r}
shapiro.test(x)
```

From the output, the p-value \> 0.05 implying that the distribution of
the data are not significantly different from normal distribution, i.e.
the null hypothesis can not be rejected. In other words, we can assume
the normality.

Estimated mean value:

```{r}
mu = mean(x)
mu
```

Next, we are going to construct a 97%-CI for $\mu$. The standard
deviation $\sigma$ is unknown, therefore, we estimate it by $s$.

```{r}
s = sd(x)
s
```

The confidence interval in such a case is based on a t-distribution and
the upper t-quantile.

```{r}
alpha <- 1 - 0.97
n <- length(x)
ta <- qt(1-alpha/2, df=n-1)
ta
```

t-confidence interval of level 97% for $\mu$:

```{r}
CI_97 <- c(mu - ta*s/sqrt(n), mu + ta*s/sqrt(n))
CI_97
```

Next, we evaluate the sample size needed to provide that the length of
the 97%-CI is at most 2. For this, we have to solve
$t_{\alpha / 2} \frac{s}{\sqrt{n}} \leq E$ for $n$.

```{r}
E <- 2 
n_min <- (ta*s/E)^2
n_min
```

To provide the length of the 97%-CI less than 2, we have to collect the
sample of at lest 88 objects.

Let's compute a bootstrap 97%-CI for $\mu$ using 1000 samples.

```{r}
B = 1000
Tstar = numeric(B)

for(i in 1:B) {
  Xstar = sample(x, replace=TRUE)
  Tstar[i] = mean(Xstar)
}

TstarLower = quantile(Tstar, alpha/2)
TstarUpper = quantile(Tstar, 1-alpha/2)

bootstrap_CI_97 <- c(2*mu - TstarUpper, 2*mu - TstarLower)
bootstrap_CI_97
```

The confidence intervals look very close to each other. The one,
calculated with a bootstrapping, is stochastic and therefore differs
from launch to launch.

**b)** The doctor claims that the mean waiting time is less than 15
minutes. Under an assumption, verify this claim by a relevant t-test,
explain the meaning of the CI in the R-output for this test. Propose and
perform a suitable sign tests for this problem. Can we use yet another
test based on ranks?

One-sided t-test with $H_0$: mean waiting time $\geq$ 15; $H_1$: mean
waiting time $<$ 15:

```{r}
t.test(x, mu=15, alt='l')
```

$H_0$ is rejected. The doctor's claim (alternative hypothesis) is
accepted. The confidence interval is also one-sided (left-sided). The
given value of 15 is outside CI and this also tells about rejecting
$H_0$.

A sign test for median of a single sample may be applied if we state the
claim as "the median waiting time is less than 15 minutes":

```{r}
binom.test(sum(x<15), length(x), p = 0.5, alternative = "less", conf.level = 0.95)
```

The calculated p-value is 0.85. Since this is not less than 0.05, we
fail to reject the null hypothesis. We do not have sufficient evidence
to say that median waiting time is less than 15 minutes.

In the same manner one-sample Wilcoxon signed rank test may be applied.

**c)** Propose a way to compute the powers of the t-test and sign test
from b) at $\mu$ = 14 and $\mu$ = 13, comment.

The powers may be computed during a simulation as a probability of
rejecting $H_0$ when $H_1$ is true. For this, we have to generate
samples from $H_1$. For both tests we can generate from normal
distribution with the mean of 15, 14, 13.

```{r}
B <- 1000

for(m in 13:15){
  ttest <- numeric(B)
  sign <- numeric(B)
  for(i in 1L:B){
    h1_sample = rnorm(n, mean=m, sd=s)
    
    ttest[i] <- t.test(h1_sample, mu=mu, alt='l')[[3]]
    sign[i] <- binom.test(sum(h1_sample<mu), length(h1_sample), p = 0.5, 
                          alternative = "less", conf.level = 0.95)[[3]]
  }
  print(paste0("H1 mu=", m))
  print(paste0("t-test power ", sum(ttest < 0.05)/B))
  print(paste0("sign test power ", sum(sign < 0.05)/B))
}
```

**d)** Let *p* be the probability that a patient has to wait longer than
15.5 minutes. Using asymptotic normality, the researcher computed the
right end $\hat{p}_{r}$= 0.53 of the confidence interval
$\left[\hat{p}_{l}, \hat{p}_{r}\right]$ for *p*. Recover the whole
confidence interval and its confidence level.

Let's estimate a proportion of patients to wait longer than 15.5
minutes. $p\_hat$ is a point estimate for $p$.

```{r}
p_hat = mean(x > 15.5)
p_hat
```

(1-$\alpha$)-confidence interval for $p$ is
$\hat{p} \pm Z_{\alpha / 2} \sqrt{\frac{\hat{p}(1-\hat{p})}{n}}$

```{r}
p_hat_r <- 0.53
margin_error = p_hat_r - p_hat
p_hat_l <- p_hat - margin_error
p_hat_l
```

Let's calculate Z alpha/2 quantile:

```{r}
se <- sqrt((p_hat * (1 - p_hat)) / n)
z_alpha_by_2 <- margin_error / se
z_alpha_by_2
```

```{r}
alpha = (1 - pnorm(z_alpha_by_2))*2
1-alpha
```

It was a 0.89-confidence interval for $p$

**e)** The researcher also reported that there were 3 men and 2 women
among 5 patients who had to wait more than 15.5 minutes, 4 men and 6
women among the remaining 10 patients. The researcher claims that the
waiting time is different for men and women. Verify this claim by an
appropriate test.

Here we test whether the proportions of men and women in two groups
waiting more and less than 15.5 minutes are significantly different. We
apply the approximate proportion test:

```{r}
prop.test(c(2, 6), c(5, 10))
```

There is no significant evidence that the waiting time is different for
men and women.
